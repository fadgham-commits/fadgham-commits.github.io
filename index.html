<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cartoon Colorful Shooter</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Trebuchet MS", system-ui, sans-serif;
  }

  body {
    background: linear-gradient(135deg, #4facfe, #f093fb);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    color: #222;
  }

  #game-wrapper {
    background: #ffffffcc;
    border-radius: 16px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
    padding: 10px;
    display: flex;
    gap: 10px;
  }

  #left-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #ui-top {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
  }

  #hp-bar-wrapper {
    background: #ddd;
    border-radius: 8px;
    width: 200px;
    height: 20px;
    overflow: hidden;
    border: 2px solid #999;
  }

  #hp-bar {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #4caf50, #8bc34a);
    transition: width 0.2s;
  }

  #coin-display {
    background: #ffe082;
    padding: 4px 10px;
    border-radius: 999px;
    border: 2px solid #ffb300;
    font-weight: bold;
    color: #6d4c00;
  }

  #stage-label {
    background: #e1bee7;
    padding: 4px 10px;
    border-radius: 999px;
    border: 2px solid #ab47bc;
    font-weight: bold;
    color: #4a0072;
  }

  #boss-banner {
    display: none;
    text-align: center;
    padding: 6px 12px;
    border-radius: 999px;
    background: linear-gradient(90deg, #ff5252, #ffca28);
    color: #fff;
    font-weight: 900;
    letter-spacing: 1px;
    animation: bossFade 0.8s ease-in-out infinite alternate;
  }

  @keyframes bossFade {
    from { transform: scale(1); opacity: 0.7; }
    to { transform: scale(1.05); opacity: 1; }
  }

  #canvas {
    background: radial-gradient(circle at top, #fff9c4, #80deea);
    border-radius: 12px;
    border: 3px solid #90caf9;
  }

  /* SHOP PANEL */
  #shop-panel {
    width: 220px;
    background: #f5f5f5;
    border-radius: 12px;
    border: 3px solid #ffb300;
    display: flex;
    flex-direction: column;
    padding: 8px;
    position: relative;
  }

  #shop-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  #shop-title {
    font-weight: 900;
    font-size: 16px;
    color: #5d4037;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #shop-cart-icon {
    width: 26px;
    height: 26px;
    border-radius: 8px;
    background: #ffcc80;
    border: 2px solid #fb8c00;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
  }

  #shop-body {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .shop-section-label {
    font-size: 13px;
    font-weight: bold;
    color: #6a1b9a;
    margin-top: 4px;
    margin-bottom: 2px;
  }

  .shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    border-radius: 8px;
    padding: 4px 6px;
    border: 1px solid #ddd;
  }

  .shop-item-left {
    display: flex;
    flex-direction: column;
    font-size: 11px;
  }

  .shop-item-name {
    font-weight: bold;
    font-size: 12px;
  }

  .shop-item-desc {
    font-size: 10px;
    color: #555;
  }

  .shop-item-cost {
    font-size: 11px;
    color: #ff6f00;
    font-weight: bold;
  }

  .shop-btn {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    border: none;
    background: #81c784;
    color: #fff;
    cursor: pointer;
  }

  .shop-btn:disabled {
    background: #bdbdbd;
    cursor: not-allowed;
  }

  .skin-preview {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2px solid #888;
    margin-right: 4px;
  }

  #shop-skins {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #shop-upgrades {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #shop-toggle-hint {
    font-size: 10px;
    color: #777;
    text-align: right;
  }

</style>
</head>
<body>
<div id="game-wrapper">
  <div id="left-panel">
    <div id="ui-top">
      <div id="hp-bar-wrapper">
        <div id="hp-bar"></div>
      </div>
      <div id="coin-display">Coins: 0</div>
      <div id="stage-label">Stage 1</div>
    </div>
    <div id="boss-banner">BOSS DATANG!</div>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>

  <div id="shop-panel">
    <div id="shop-header">
      <div id="shop-title">
        <div id="shop-cart-icon">ðŸ›’</div>
        <span>Shop</span>
      </div>
    </div>
    <div id="shop-body">
      <div id="shop-toggle-hint">Klik keranjang untuk show/hide shop</div>

      <div class="shop-section-label">Skins</div>
      <div id="shop-skins">
        <!-- Filled by JS -->
      </div>

      <div class="shop-section-label">Upgrades Permanen</div>
      <div id="shop-upgrades">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const hpBar = document.getElementById("hp-bar");
  const coinDisplay = document.getElementById("coin-display");
  const stageLabel = document.getElementById("stage-label");
  const bossBanner = document.getElementById("boss-banner");

  const shopPanel = document.getElementById("shop-panel");
  const shopCartIcon = document.getElementById("shop-cart-icon");
  const shopSkins = document.getElementById("shop-skins");
  const shopUpgrades = document.getElementById("shop-upgrades");

  const keys = {};
  let mouseX = canvas.width / 2;
  let mouseY = canvas.height / 2;

  // ======= PLAYER BASE STATS & STATE =======
  const PLAYER_BASE = {
    maxHp: 100,
    moveSpeed: 3.5,
    dmg: 10,
    fireRate: 0.7, // pelan di awal (detik per peluru)
  };

  const player = {
    x: canvas.width / 2,
    y: canvas.height - 80,
    radius: 18,
    color: "#ff7043",
    maxHp: PLAYER_BASE.maxHp,
    hp: PLAYER_BASE.maxHp,
    moveSpeed: PLAYER_BASE.moveSpeed,
    dmg: PLAYER_BASE.dmg,
    fireRate: PLAYER_BASE.fireRate,
    lastShotTime: 0,
    skinId: "default",
  };

  // Permanent upgrades (akumulatif, ngubah BASE)
  const permUpgrades = {
    hpLevel: 0,
    dmgLevel: 0,
    fireRateLevel: 0,
  };

  // ======= GAME STATE =======
  let coins = 0;
  let bullets = [];
  let enemies = [];
  let particles = [];
  let items = [];
  let secretUnits = [];
  let lastEnemySpawn = 0;
  let enemySpawnCooldown = 1.5; // musuh muncul tiap 1.5 detik (akan makin cepat)
  let gameTime = 0;
  let stage = 1;
  let boss = null;
  let inBossTransition = false;
  let bossTransitionTime = 0;

  // Secret unit drop chance
  const SECRET_DROP_CHANCE = 0.08; // 8%

  // ======= SHOP CONFIG =======
  const skinList = [
    {
      id: "default",
      name: "Default Blaster",
      cost: 0,
      color: "#ff7043",
      desc: "Skin awal standar.",
    },
    {
      id: "aqua",
      name: "Aqua Jet",
      cost: 40,
      color: "#26c6da",
      desc: "+ Sedikit aura kece.",
    },
    {
      id: "neon",
      name: "Neon Bolt",
      cost: 80,
      color: "#d4e157",
      desc: "Kelihatan pro banget.",
    },
  ];

  const upgradeList = [
    {
      id: "hp",
      name: "Max HP+",
      desc: "Naikkan max HP +20.",
      baseCost: 30,
      maxLevel: 5,
      applyUpgrade: () => {
        permUpgrades.hpLevel++;
        PLAYER_BASE.maxHp += 20;
        player.maxHp = PLAYER_BASE.maxHp;
        player.hp = player.maxHp;
      },
    },
    {
      id: "dmg",
      name: "Damage+",
      desc: "Naikkan damage +3.",
      baseCost: 25,
      maxLevel: 7,
      applyUpgrade: () => {
        permUpgrades.dmgLevel++;
        PLAYER_BASE.dmg += 3;
        player.dmg = PLAYER_BASE.dmg;
      },
    },
    {
      id: "firerate",
      name: "Fire Rate+",
      desc: "Percepat tembakan.",
      baseCost: 35,
      maxLevel: 7,
      applyUpgrade: () => {
        permUpgrades.fireRateLevel++;
        PLAYER_BASE.fireRate *= 0.9; // semakin kecil = lebih cepat
        player.fireRate = PLAYER_BASE.fireRate;
      },
    },
  ];

  // =================== INPUT HANDLING ===================
  document.addEventListener("keydown", (e) => {
    keys[e.key.toLowerCase()] = true;
  });

  document.addEventListener("keyup", (e) => {
    keys[e.key.toLowerCase()] = false;
  });

  canvas.addEventListener("mousemove", (e) => {
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
  });

  // =================== SHOP UI BUILD ===================
  function buildShopUI() {
    // Skins
    shopSkins.innerHTML = "";
    skinList.forEach((skin) => {
      const row = document.createElement("div");
      row.className = "shop-item";

      const left = document.createElement("div");
      left.className = "shop-item-left";

      const topLine = document.createElement("div");
      topLine.style.display = "flex";
      topLine.style.alignItems = "center";

      const preview = document.createElement("div");
      preview.className = "skin-preview";
      preview.style.background = skin.color;
      topLine.appendChild(preview);

      const name = document.createElement("div");
      name.className = "shop-item-name";
      name.textContent = skin.name;
      topLine.appendChild(name);

      const desc = document.createElement("div");
      desc.className = "shop-item-desc";
      desc.textContent = skin.desc;

      left.appendChild(topLine);
      left.appendChild(desc);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.flexDirection = "column";
      right.style.alignItems = "flex-end";

      const cost = document.createElement("div");
      cost.className = "shop-item-cost";
      cost.textContent = skin.cost + "c";
      right.appendChild(cost);

      const btn = document.createElement("button");
      btn.className = "shop-btn";
      btn.textContent = skin.id === player.skinId ? "Dipakai" : "Pilih";

      btn.addEventListener("click", () => {
        if (skin.id === player.skinId) return;

        if (skin.cost > coins) return;

        coins -= skin.cost;
        coinDisplay.textContent = "Coins: " + coins;
        player.skinId = skin.id;
        player.color = skin.color;
        buildShopUI();
      });

      right.appendChild(btn);

      row.appendChild(left);
      row.appendChild(right);
      shopSkins.appendChild(row);
    });

    // Upgrades
    shopUpgrades.innerHTML = "";
    upgradeList.forEach((up) => {
      const row = document.createElement("div");
      row.className = "shop-item";

      const left = document.createElement("div");
      left.className = "shop-item-left";

      const name = document.createElement("div");
      name.className = "shop-item-name";
      name.textContent = up.name;

      const desc = document.createElement("div");
      desc.className = "shop-item-desc";
      desc.textContent = up.desc;

      left.appendChild(name);
      left.appendChild(desc);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.flexDirection = "column";
      right.style.alignItems = "flex-end";

      const level = getUpgradeLevel(up.id);
      const costVal = up.baseCost + level * 15;
      const maxed = level >= up.maxLevel;

      const cost = document.createElement("div");
      cost.className = "shop-item-cost";
      cost.textContent = maxed ? "MAX" : costVal + "c";

      const btn = document.createElement("button");
      btn.className = "shop-btn";
      btn.textContent = maxed ? "âœ”" : "Upgrade";

      btn.disabled = maxed || coins < costVal;

      btn.addEventListener("click", () => {
        if (maxed) return;
        if (coins < costVal) return;

        coins -= costVal;
        coinDisplay.textContent = "Coins: " + coins;
        up.applyUpgrade();
        buildShopUI();
      });

      right.appendChild(cost);
      right.appendChild(btn);

      row.appendChild(left);
      row.appendChild(right);
      shopUpgrades.appendChild(row);
    });
  }

  function getUpgradeLevel(id) {
    if (id === "hp") return permUpgrades.hpLevel;
    if (id === "dmg") return permUpgrades.dmgLevel;
    if (id === "firerate") return permUpgrades.fireRateLevel;
    return 0;
  }

  shopCartIcon.addEventListener("click", () => {
    const body = document.getElementById("shop-body");
    const visible = body.style.display !== "none";
    body.style.display = visible ? "none" : "flex";
  });

  // =================== GAME HELPERS ===================
  function updateHpBar() {
    const ratio = Math.max(0, player.hp) / player.maxHp;
    hpBar.style.width = ratio * 100 + "%";

    if (ratio > 0.6) {
      hpBar.style.background = "linear-gradient(90deg,#4caf50,#8bc34a)";
    } else if (ratio > 0.3) {
      hpBar.style.background = "linear-gradient(90deg,#ffb300,#ffca28)";
    } else {
      hpBar.style.background = "linear-gradient(90deg,#e53935,#ff7043)";
    }
  }

  function spawnEnemy() {
    const side = Math.random() < 0.5 ? "top" : "sides";
    let x, y;

    if (side === "top") {
      x = Math.random() * canvas.width;
      y = -20;
    } else {
      x = Math.random() < 0.5 ? -20 : canvas.width + 20;
      y = Math.random() * (canvas.height * 0.6);
    }

    const baseSpeed = 1.2 + stage * 0.2;
    enemies.push({
      x,
      y,
      radius: 14,
      hp: 20 + stage * 4,
      maxHp: 20 + stage * 4,
      speed: baseSpeed,
      color: "#ec407a",
    });
  }

  function spawnBoss() {
    boss = {
      x: canvas.width / 2,
      y: 80,
      radius: 40,
      hp: 300 + stage * 100,
      maxHp: 300 + stage * 100,
      color: "#ab47bc",
      phase: 1,
      shootTimer: 0,
    };
  }

  function spawnItem(x, y) {
    const typeRoll = Math.random();
    let type = "coin";

    if (typeRoll < 0.2) type = "heal";
    else type = "coin";

    items.push({
      x,
      y,
      radius: 10,
      type,
    });

    if (Math.random() < SECRET_DROP_CHANCE) {
      secretUnits.push({
        x,
        y,
        radius: 14,
        color: "#00e676",
        hpBoost: 10,
        dmgBoost: 2,
        speedBoost: 0.3,
      });
    }
  }

  function createExplosion(x, y, color) {
    for (let i = 0; i < 10; i++) {
      const angle = Math.random() * Math.PI * 2;
      const speed = Math.random() * 2 + 1;
      particles.push({
        x,
        y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        life: 30,
        color,
      });
    }
  }

  function distance(a, b) {
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  // =================== GAME LOOP ===================
  let lastTime = 0;
  function loop(timestamp) {
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;
    gameTime += dt;

    update(dt);
    draw();

    requestAnimationFrame(loop);
  }

  function update(dt) {
    // Stage & boss timing
    if (!boss && !inBossTransition && stage <= 3) {
      if (gameTime > stage * 25) {
        inBossTransition = true;
        bossTransitionTime = 0;
        bossBanner.style.display = "block";
      }
    }

    if (inBossTransition) {
      bossTransitionTime += dt;
      // Slow down enemy spawn, maybe fade background idea (visual)
      if (bossTransitionTime > 2) {
        inBossTransition = false;
        bossBanner.style.display = "none";
        spawnBoss();
      }
    }

    // Player move WASD
    let vx = 0, vy = 0;
    if (keys["w"]) vy -= 1;
    if (keys["s"]) vy += 1;
    if (keys["a"]) vx -= 1;
    if (keys["d"]) vx += 1;

    const len = Math.hypot(vx, vy);
    if (len > 0) {
      vx /= len;
      vy /= len;
    }

    player.x += vx * player.moveSpeed * 60 * dt;
    player.y += vy * player.moveSpeed * 60 * dt;

    // clamp
    player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
    player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));

    // auto shooting
    player.lastShotTime += dt;
    if (player.lastShotTime >= player.fireRate) {
      shootBullet();
      player.lastShotTime = 0;
    }

    // spawn enemy (only if no boss)
    if (!boss && !inBossTransition) {
      lastEnemySpawn += dt;
      if (lastEnemySpawn >= enemySpawnCooldown) {
        spawnEnemy();
        lastEnemySpawn = 0;

        // makin lama, spawn makin cepat
        enemySpawnCooldown = Math.max(0.6, enemySpawnCooldown - 0.02);
      }
    }

    // update bullets
    bullets = bullets.filter((b) => !b.dead);
    bullets.forEach((b) => {
      b.x += b.vx * dt;
      b.y += b.vy * dt;

      if (b.x < -20 || b.x > canvas.width + 20 || b.y < -20 || b.y > canvas.height + 20) {
        b.dead = true;
      }
    });

    // enemies
    enemies = enemies.filter((e) => !e.dead);
    enemies.forEach((e) => {
      const dx = player.x - e.x;
      const dy = player.y - e.y;
      const dist = Math.hypot(dx, dy);
      const spd = e.speed * 60 * dt;

      if (dist > 1) {
        e.x += (dx / dist) * spd;
        e.y += (dy / dist) * spd;
      }

      // enemy collide player
      if (distance(e, player) < e.radius + player.radius) {
        e.dead = true;
        takeDamage(10);
        createExplosion(e.x, e.y, e.color);
      }
    });

    // bullets vs enemies
    bullets.forEach((b) => {
      enemies.forEach((e) => {
        if (!b.dead && !e.dead && distance(b, e) < b.radius + e.radius) {
          e.hp -= player.dmg;
          b.dead = true;
          createExplosion(b.x, b.y, "#fff176");
          if (e.hp <= 0) {
            e.dead = true;
            coins += 3 + stage;
            coinDisplay.textContent = "Coins: " + coins;
            spawnItem(e.x, e.y);
          }
        }
      });
    });

    // boss logic
    if (boss) {
      const targetX = canvas.width / 2 + Math.sin(gameTime * 1.2) * 180;
      boss.x += (targetX - boss.x) * 0.03 * 60 * dt;

      boss.shootTimer += dt;
      if (boss.shootTimer > 1) {
        boss.shootTimer = 0;
        // radial bullets
        const bulletCount = 8 + stage * 2;
        for (let i = 0; i < bulletCount; i++) {
          const angle = (Math.PI * 2 * i) / bulletCount;
          enemies.push({
            x: boss.x,
            y: boss.y,
            radius: 6,
            hp: 1,
            maxHp: 1,
            speed: 3 + stage * 0.5,
            color: "#ff7043",
            isBossBullet: true,
          });
        }
      }

      // bullet vs boss
      bullets.forEach((b) => {
        if (!b.dead && distance(b, boss) < b.radius + boss.radius) {
          b.dead = true;
          boss.hp -= player.dmg;
          createExplosion(b.x, b.y, "#fff59d");
          if (boss.hp <= boss.maxHp * 0.5 && boss.phase === 1) {
            boss.phase = 2;
            boss.color = "#ef5350";
          }
          if (boss.hp <= 0) {
            createExplosion(boss.x, boss.y, "#ffea00");
            coins += 100;
            coinDisplay.textContent = "Coins: " + coins;
            boss = null;
            stage++;
            stageLabel.textContent = "Stage " + stage;
            enemySpawnCooldown = 1.4;
          }
        }
      });

      if (distance(player, boss) < player.radius + boss.radius) {
        takeDamage(20);
      }
    }

    // items
    items = items.filter((it) => !it.dead);
    items.forEach((it) => {
      if (distance(player, it) < player.radius + it.radius) {
        it.dead = true;
        if (it.type === "coin") {
          coins += 5;
        } else if (it.type === "heal") {
          player.hp = Math.min(player.maxHp, player.hp + 20);
        }
        coinDisplay.textContent = "Coins: " + coins;
        updateHpBar();
      }
    });

    // secret units
    secretUnits = secretUnits.filter((s) => !s.dead);
    secretUnits.forEach((s) => {
      if (distance(player, s) < player.radius + s.radius) {
        s.dead = true;
        player.maxHp += s.hpBoost;
        player.hp += s.hpBoost;
        player.dmg += s.dmgBoost;
        player.moveSpeed += s.speedBoost;
        updateHpBar();
        createExplosion(s.x, s.y, s.color);
      }
    });

    // particles
    particles = particles.filter((p) => p.life > 0);
    particles.forEach((p) => {
      p.x += p.vx;
      p.y += p.vy;
      p.life--;
    });

    updateHpBar();
  }

  function drawPlayer() {
    // body
    ctx.save();
    ctx.translate(player.x, player.y);

    // arahkan ke mouse
    const angle = Math.atan2(mouseY - player.y, mouseX - player.x);
    ctx.rotate(angle);

    // body circle
    ctx.fillStyle = player.color;
    ctx.beginPath();
    ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
    ctx.fill();

    // "turret"
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, -6, player.radius + 10, 12);

    ctx.restore();
  }

  function drawEnemies() {
    enemies.forEach((e) => {
      ctx.save();
      ctx.translate(e.x, e.y);
      ctx.fillStyle = e.color;
      ctx.beginPath();
      ctx.arc(0, 0, e.radius, 0, Math.PI * 2);
      ctx.fill();

      if (!e.isBossBullet) {
        // HP bar
        const ratio = e.hp / e.maxHp;
        ctx.fillStyle = "#37474f";
        ctx.fillRect(-e.radius, -e.radius - 8, e.radius * 2, 4);
        ctx.fillStyle = "#66bb6a";
        ctx.fillRect(-e.radius, -e.radius - 8, e.radius * 2 * ratio, 4);
      }
      ctx.restore();
    });
  }

  function drawBoss() {
    if (!boss) return;
    ctx.save();
    ctx.translate(boss.x, boss.y);
    ctx.fillStyle = boss.color;
    ctx.beginPath();
    ctx.arc(0, 0, boss.radius, 0, Math.PI * 2);
    ctx.fill();

    // face
    ctx.fillStyle = "#ffffff";
    ctx.beginPath();
    ctx.arc(-12, -8, 6, 0, Math.PI * 2);
    ctx.arc(12, -8, 6, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#000000";
    ctx.beginPath();
    ctx.arc(-12, -8, 3, 0, Math.PI * 2);
    ctx.arc(12, -8, 3, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(0, 10, 12, 0, Math.PI);
    ctx.stroke();

    // boss HP bar atas
    ctx.restore();
    const barWidth = 260;
    const barHeight = 12;
    const ratio = boss.hp / boss.maxHp;

    ctx.fillStyle = "#263238";
    ctx.fillRect(canvas.width / 2 - barWidth / 2, 10, barWidth, barHeight);
    ctx.fillStyle = "#ff5252";
    ctx.fillRect(canvas.width / 2 - barWidth / 2, 10, barWidth * ratio, barHeight);

    ctx.fillStyle = "#ffffff";
    ctx.font = "11px Trebuchet MS";
    ctx.textAlign = "center";
    ctx.fillText("BOSS", canvas.width / 2, 19);
  }

  function drawItems() {
    items.forEach((it) => {
      ctx.save();
      ctx.translate(it.x, it.y);
      if (it.type === "coin") {
        ctx.fillStyle = "#ffd54f";
        ctx.beginPath();
        ctx.arc(0, 0, it.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#8d6e63";
        ctx.font = "12px Trebuchet MS";
        ctx.textAlign = "center";
        ctx.fillText("C", 0, 4);
      } else {
        ctx.fillStyle = "#81c784";
        ctx.beginPath();
        ctx.arc(0, 0, it.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#1b5e20";
        ctx.font = "12px Trebuchet MS";
        ctx.textAlign = "center";
        ctx.fillText("+", 0, 4);
      }
      ctx.restore();
    });

    secretUnits.forEach((s) => {
      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.fillStyle = s.color;
      ctx.beginPath();
      ctx.arc(0, 0, s.radius, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = "#004d40";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-5, 0);
      ctx.lineTo(0, 8);
      ctx.lineTo(8, -6);
      ctx.stroke();

      ctx.restore();
    });
  }

  function drawBullets() {
    bullets.forEach((b) => {
      ctx.save();
      ctx.translate(b.x, b.y);
      ctx.fillStyle = "#fff59d";
      ctx.beginPath();
      ctx.arc(0, 0, b.radius, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    });
  }

  function drawParticles() {
    particles.forEach((p) => {
      ctx.globalAlpha = p.life / 30;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // background cartoon clouds
    ctx.fillStyle = "rgba(255,255,255,0.35)";
    for (let i = 0; i < 3; i++) {
      const y = 60 + i * 80 + Math.sin(gameTime * 0.4 + i) * 10;
      ctx.beginPath();
      ctx.ellipse(120 + i * 180, y, 60, 24, 0, 0, Math.PI * 2);
      ctx.fill();
    }

    drawPlayer();
    drawEnemies();
    drawBoss();
    drawItems();
    drawBullets();
    drawParticles();
  }

  function shootBullet() {
    const angle = Math.atan2(mouseY - player.y, mouseX - player.x);
    const speed = 420;

    bullets.push({
      x: player.x + Math.cos(angle) * (player.radius + 10),
      y: player.y + Math.sin(angle) * (player.radius + 10),
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      radius: 6,
      dead: false,
    });
  }

  function takeDamage(amount) {
    player.hp -= amount;
    if (player.hp <= 0) {
      player.hp = 0;
      // simple game over reset
      createExplosion(player.x, player.y, "#ff1744");
      alert("Game Over! Coins: " + coins + "\nReload page untuk mulai lagi.");
      // freeze game
      player.moveSpeed = 0;
      player.fireRate = 999999;
    }
    updateHpBar();
  }

  // init
  buildShopUI();
  updateHpBar();
  requestAnimationFrame(loop);
</script>
</body>
</html>
