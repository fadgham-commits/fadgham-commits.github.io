<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cartoon Colorful Shooter Plus Upgrades</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Segoe UI", system-ui, sans-serif;
  }

  body {
    background: linear-gradient(135deg, #ffd3ba, #ffe8a3);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    color: #333;
  }

  #game-container {
    position: relative;
    width: 900px;
    height: 550px;
    background: #fdfcff;
    border-radius: 24px;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
  }

  canvas {
    display: block;
    background: radial-gradient(circle at top, #ffffff 0%, #f5f1ff 45%, #fffbf0 100%);
  }

  /* Top UI bar */
  #top-ui {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    pointer-events: none;
  }

  .ui-section {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* HP bar */
  #hp-bar-wrapper {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 999px;
    padding: 4px 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }

  #hp-label {
    font-size: 13px;
    font-weight: 600;
    color: #444;
  }

  #hp-bar {
    width: 200px;
    height: 14px;
    background: #ffe1e1;
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid #ffb3b3;
  }

  #hp-fill {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #ff6c6c, #ffb347);
    transition: width 0.15s linear;
  }

  /* Coin display */
  #coin-display {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 999px;
    padding: 6px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }

  #coin-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #fff7c2, #ffc800);
    border: 2px solid #e1a400;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 800;
    color: #8b5a00;
  }

  #coin-text {
    font-weight: 600;
    font-size: 14px;
  }

  /* Shop button */
  #shop-button {
    pointer-events: auto;
    width: 46px;
    height: 46px;
    border-radius: 16px;
    background: #ffb347;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
  }

  #shop-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.18);
    background: #ff9f1c;
  }

  #shop-button:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
  }

  #shop-button-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    border: 2px solid #fff;
    position: relative;
  }

  #shop-button-icon::before,
  #shop-button-icon::after {
    content: "";
    position: absolute;
    background: #fff;
  }

  /* cart wheels */
  #shop-button-icon::before {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    bottom: -6px;
    left: 3px;
    box-shadow: 12px 0 0 0 #fff;
  }

  /* cart handle + basket */
  #shop-button-icon::after {
    width: 14px;
    height: 12px;
    border-radius: 3px;
    border: 2px solid #fff;
    border-top: none;
    border-left: none;
    transform: skewX(-12deg);
    top: 3px;
    left: 5px;
  }

  /* Boss incoming overlay */
  #boss-overlay {
    position: absolute;
    inset: 0;
    background: rgba(10, 5, 40, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffe9a3;
    font-size: 40px;
    font-weight: 800;
    letter-spacing: 4px;
    text-shadow: 0 0 18px rgba(255, 230, 120, 0.8);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }

  /* Game over overlay */
  #game-over-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 5, 30, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #fff7e2;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }

  #game-over-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  #game-over-overlay h1 {
    font-size: 40px;
    margin-bottom: 8px;
  }

  #game-over-overlay p {
    margin-bottom: 18px;
  }

  #restart-button {
    pointer-events: auto;
    padding: 10px 24px;
    border-radius: 999px;
    border: none;
    background: #ff6c6c;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
  }

  #restart-button:hover {
    background: #ff5050;
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.22);
  }

  #restart-button:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
  }

  /* Shop panel */
  #shop-panel {
    position: absolute;
    right: 16px;
    top: 70px;
    width: 280px;
    background: rgba(255, 255, 255, 0.96);
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
    padding: 12px 12px 16px 12px;
    transform: translateY(-10px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  #shop-panel.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  #shop-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 8px;
  }

  #shop-title {
    font-size: 16px;
    font-weight: 700;
  }

  #shop-subtitle {
    font-size: 11px;
    color: #777;
  }

  /* tabs */
  #shop-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
  }

  .shop-tab {
    flex: 1;
    padding: 4px 0;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    background: #f3f4ff;
    color: #4b5563;
    transition: background 0.1s ease, color 0.1s ease;
  }

  .shop-tab.active {
    background: #ffb347;
    color: #fff;
  }

  #shop-content {
    min-height: 110px;
  }

  /* Skin grid */
  #skin-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
  }

  .skin-card {
    background: #fdf4ff;
    border-radius: 16px;
    padding: 6px;
    border: 2px solid transparent;
    display: flex;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.1s ease, border 0.1s ease, background 0.1s ease;
  }

  .skin-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12);
  }

  .skin-card.selected {
    border-color: #ff9f1c;
    background: #fff8e8;
  }

  .skin-preview {
    height: 40px;
    border-radius: 12px;
    background: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: #555;
  }

  .skin-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
  }

  .skin-name {
    font-weight: 700;
  }

  .skin-price {
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .skin-price-coin {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: radialGradient(circle at 30% 30%, #fff7c2, #ffc800);
  }

  .skin-price-coin {
    background: radial-gradient(circle at 30% 30%, #fff7c2, #ffc800);
    border: 1px solid #e1a400;
    font-size: 9px;
    font-weight: 800;
    color: #8b5a00;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .skin-status {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 999px;
    background: #e5e5ff;
    color: #4747c7;
  }

  .skin-status.owned {
    background: #d6ffe0;
    color: #228b4e;
  }

  .skin-status.equipped {
    background: #ffd9a8;
    color: #d96500;
  }

  /* Upgrade list */
  #upgrade-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .upgrade-card {
    border-radius: 12px;
    padding: 6px 8px;
    background: #f3f4ff;
    display: flex;
    flex-direction: column;
    gap: 2px;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
  }

  .upgrade-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
    background: #e5e7ff;
  }

  .upgrade-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-weight: 600;
  }

  .upgrade-desc {
    font-size: 11px;
    color: #4b5563;
  }

  .upgrade-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
  }

  .upgrade-level {
    font-weight: 600;
  }

  .upgrade-price {
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .upgrade-price-coin {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #fff7c2, #ffc800);
    border: 1px solid #e1a400;
    font-size: 9px;
    font-weight: 800;
    color: #8b5a00;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .upgrade-max {
    font-size: 10px;
    font-weight: 700;
    color: #16a34a;
  }

</style>
</head>
<body>
<div id="game-container">
  <canvas id="game" width="900" height="550"></canvas>

  <div id="top-ui">
    <div class="ui-section">
      <div id="hp-bar-wrapper">
        <span id="hp-label">HP</span>
        <div id="hp-bar">
          <div id="hp-fill"></div>
        </div>
      </div>
    </div>

    <div class="ui-section">
      <div id="coin-display">
        <div id="coin-icon">C</div>
        <div id="coin-text">0</div>
      </div>

      <button id="shop-button" title="Shop">
        <div id="shop-button-icon"></div>
      </button>
    </div>
  </div>

  <div id="boss-overlay">BOSS INCOMING</div>

  <!-- SHOP PANEL -->
  <div id="shop-panel">
    <div id="shop-header">
      <div id="shop-title">Shop</div>
      <div id="shop-subtitle">Tap untuk beli / upgrade</div>
    </div>

    <div id="shop-tabs">
      <button class="shop-tab active" data-tab="skins">Skins</button>
      <button class="shop-tab" data-tab="upgrades">Upgrades</button>
    </div>

    <div id="shop-content">
      <div id="skin-grid"></div>
      <div id="upgrade-list" style="display:none;"></div>
    </div>
  </div>

  <div id="game-over-overlay">
    <h1>GAME OVER</h1>
    <p>Click restart to try again. Coins stay!</p>
    <button id="restart-button">Restart</button>
  </div>
</div>

<script>
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const hpFill = document.getElementById("hp-fill");
  const coinText = document.getElementById("coin-text");
  const bossOverlay = document.getElementById("boss-overlay");
  const gameOverOverlay = document.getElementById("game-over-overlay");
  const restartButton = document.getElementById("restart-button");
  const shopButton = document.getElementById("shop-button");
  const shopPanel = document.getElementById("shop-panel");
  const skinGrid = document.getElementById("skin-grid");
  const upgradeList = document.getElementById("upgrade-list");
  const shopTabs = document.querySelectorAll(".shop-tab");

  const GAME_WIDTH = canvas.width;
  const GAME_HEIGHT = canvas.height;

  // ====== STORAGE KEYS ======
  const COIN_KEY = "cartoon_shooter_coins_v2";
  const SKIN_KEY = "cartoon_shooter_skins_v2";
  const EQUIPPED_SKIN_KEY = "cartoon_shooter_equipped_skin_v2";
  const UPGRADE_KEY = "cartoon_shooter_upgrades_v2";

  // ====== MOUSE ======
  let mouseX = GAME_WIDTH / 2;
  let mouseY = GAME_HEIGHT / 2;

  // ====== BASE PLAYER STATS ======
  const basePlayerStats = {
    maxHp: 100,
    dmg: 12,
    speed: 3.0,
    fireRate: 0.8, // peluru per detik (awal lambat)
  };

  // SECRET BONUS
  const secretBonus = {
    maxHpBonus: 40,
    dmgBonus: 8,
    speedBonus: 1.5,
    fireRateBonus: 0.5
  };

  // ====== UPGRADE DATA ======
  const upgrades = {
    fireRate: {
      id: "fireRate",
      name: "Fire Rate",
      level: 0,
      maxLevel: 10,
      baseCost: 30,
      costMult: 1.4,
      perLevel: 0.12, // tambah fireRate
      desc: "+Fire rate (tembakan lebih cepat)"
    },
    damage: {
      id: "damage",
      name: "Damage",
      level: 0,
      maxLevel: 10,
      baseCost: 40,
      costMult: 1.45,
      perLevel: 1.8,
      desc: "+Damage peluru"
    },
    maxHp: {
      id: "maxHp",
      name: "Max HP",
      level: 0,
      maxLevel: 10,
      baseCost: 35,
      costMult: 1.4,
      perLevel: 8,
      desc: "+HP maksimum"
    }
  };

  // ====== PLAYER OBJECT ======
  let player = {
    x: GAME_WIDTH / 2,
    y: GAME_HEIGHT / 2,
    radius: 18,
    hp: basePlayerStats.maxHp,
    maxHp: basePlayerStats.maxHp,
    dmg: basePlayerStats.dmg,
    speed: basePlayerStats.speed,
    fireRate: basePlayerStats.fireRate,
    color: "#ff6c6c",
    outline: "#ffb347",
    hasSecret: false
  };

  // ====== GAME STATE ======
  let coins = 0;
  let enemies = [];
  let bullets = [];
  let items = [];
  let boss = null;
  let inBossFight = false;
  let bossIncoming = false;

  let spawnCooldown = 1.6;
  let spawnTimer = 0;
  let wave = 1;
  let enemiesThisWave = 0;
  let enemiesKilledThisWave = 0;
  let enemiesPerWave = 12;
  let waveTransitionPause = 0;

  let shootTimer = 0;
  let lastTime = 0;
  let gameOver = false;

  // ====== SKINS ======
  const skins = [
    {
      id: "default",
      name: "Default",
      price: 0,
      color: "#ff6c6c",
      outline: "#ffb347",
      owned: true,
      bonus: { hp: 0, dmg: 0, speed: 0, fireRate: 0 }
    },
    {
      id: "mint-blaster",
      name: "Mint Blaster",
      price: 50,
      color: "#5eead4",
      outline: "#22c55e",
      owned: false,
      bonus: { hp: 10, dmg: 2, speed: 0.3, fireRate: 0.1 }
    },
    {
      id: "violet-orb",
      name: "Violet Orb",
      price: 80,
      color: "#a855f7",
      outline: "#f97316",
      owned: false,
      bonus: { hp: 15, dmg: 4, speed: 0, fireRate: 0.15 }
    },
    {
      id: "sunny-rocket",
      name: "Sunny Rocket",
      price: 120,
      color: "#facc15",
      outline: "#fb923c",
      owned: false,
      bonus: { hp: 5, dmg: 6, speed: 0.6, fireRate: 0.05 }
    }
  ];

  let equippedSkinId = "default";

  // ====== LOAD PERSISTED DATA ======
  function loadPersisted() {
    const savedCoins = parseInt(localStorage.getItem(COIN_KEY) || "0", 10);
    if (!isNaN(savedCoins)) coins = savedCoins;

    const savedSkinData = JSON.parse(localStorage.getItem(SKIN_KEY) || "null");
    if (savedSkinData && Array.isArray(savedSkinData)) {
      skins.forEach(s => {
        const found = savedSkinData.find(ss => ss.id === s.id);
        if (found) s.owned = !!found.owned;
      });
    }

    const savedEquipped = localStorage.getItem(EQUIPPED_SKIN_KEY);
    if (savedEquipped) equippedSkinId = savedEquipped;

    const savedUpgrades = JSON.parse(localStorage.getItem(UPGRADE_KEY) || "null");
    if (savedUpgrades) {
      Object.keys(upgrades).forEach(k => {
        if (savedUpgrades[k] != null) upgrades[k].level = savedUpgrades[k];
      });
    }
  }

  function saveCoins() {
    localStorage.setItem(COIN_KEY, String(coins));
  }

  function saveSkins() {
    const data = skins.map(s => ({ id: s.id, owned: s.owned }));
    localStorage.setItem(SKIN_KEY, JSON.stringify(data));
  }

  function saveEquippedSkin() {
    localStorage.setItem(EQUIPPED_SKIN_KEY, equippedSkinId);
  }

  function saveUpgrades() {
    const data = {};
    Object.keys(upgrades).forEach(k => {
      data[k] = upgrades[k].level;
    });
    localStorage.setItem(UPGRADE_KEY, JSON.stringify(data));
  }

  // ====== UI UPDATE ======
  function updateCoinUI() {
    coinText.textContent = coins;
  }

  function updateHPUI() {
    const ratio = Math.max(0, player.hp) / player.maxHp;
    hpFill.style.width = (ratio * 100) + "%";

    if (ratio > 0.6) {
      hpFill.style.background = "linear-gradient(90deg, #4ade80, #a3e635)";
    } else if (ratio > 0.3) {
      hpFill.style.background = "linear-gradient(90deg, #facc15, #fb923c)";
    } else {
      hpFill.style.background = "linear-gradient(90deg, #f97373, #fb7185)";
    }
  }

  // ====== APPLY STATS ======
  function applyBaseStats() {
    player.maxHp = basePlayerStats.maxHp;
    player.dmg = basePlayerStats.dmg;
    player.speed = basePlayerStats.speed;
    player.fireRate = basePlayerStats.fireRate;

    // Upgrades effect
    const up = upgrades;
    player.fireRate += up.fireRate.level * up.fireRate.perLevel;
    player.dmg += up.damage.level * up.damage.perLevel;
    player.maxHp += up.maxHp.level * up.maxHp.perLevel;

    // Skin bonus
    const skin = skins.find(s => s.id === equippedSkinId) || skins[0];
    if (skin && skin.bonus) {
      player.maxHp += skin.bonus.hp;
      player.dmg += skin.bonus.dmg;
      player.speed += skin.bonus.speed;
      player.fireRate += skin.bonus.fireRate;
    }

    // Secret unit bonus
    if (player.hasSecret) {
      player.maxHp += secretBonus.maxHpBonus;
      player.dmg += secretBonus.dmgBonus;
      player.speed += secretBonus.speedBonus;
      player.fireRate += secretBonus.fireRateBonus;
    }

    // Bound minimal biar ga aneh
    if (player.fireRate < 0.2) player.fireRate = 0.2;

    // refill hp setelah update stat
    player.hp = player.maxHp;
    updateHPUI();
  }

  function applySkinVisual() {
    const skin = skins.find(s => s.id === equippedSkinId) || skins[0];
    player.color = skin.color;
    player.outline = skin.outline;
  }

  function equipSkin(id) {
    const skin = skins.find(s => s.id === id);
    if (!skin || !skin.owned) return;
    equippedSkinId = id;
    saveEquippedSkin();
    applySkinVisual();
    applyBaseStats();
    renderShop();
  }

  function buyOrEquipSkin(id) {
    const skin = skins.find(s => s.id === id);
    if (!skin) return;

    if (!skin.owned) {
      if (coins >= skin.price) {
        coins -= skin.price;
        skin.owned = true;
        updateCoinUI();
        saveCoins();
        saveSkins();
      } else {
        return;
      }
    }
    equipSkin(id);
  }

  // ====== SHOP RENDER ======
  function renderSkins() {
    skinGrid.innerHTML = "";
    skins.forEach(s => {
      const card = document.createElement("div");
      card.className = "skin-card";
      if (equippedSkinId === s.id) card.classList.add("selected");

      const preview = document.createElement("div");
      preview.className = "skin-preview";
      preview.style.background = "radial-gradient(circle at 30% 20%, #ffffff, " + s.color + ")";
      preview.style.boxShadow = "0 0 0 3px " + s.outline + "44";
      preview.textContent = s.name;

      const meta = document.createElement("div");
      meta.className = "skin-meta";

      const name = document.createElement("div");
      name.className = "skin-name";
      name.textContent = s.name;

      const status = document.createElement("div");
      status.className = "skin-status";
      if (!s.owned) {
        status.textContent = "Locked";
      } else if (equippedSkinId === s.id) {
        status.textContent = "Equipped";
        status.classList.add("equipped");
      } else {
        status.textContent = "Owned";
        status.classList.add("owned");
      }

      meta.appendChild(name);
      meta.appendChild(status);

      const price = document.createElement("div");
      price.className = "skin-price";
      if (s.price > 0) {
        const c = document.createElement("div");
        c.className = "skin-price-coin";
        c.textContent = "C";
        const t = document.createElement("span");
        t.textContent = s.price;
        price.appendChild(c);
        price.appendChild(t);
      } else {
        price.textContent = "FREE";
      }

      card.appendChild(preview);
      card.appendChild(meta);
      card.appendChild(price);

      card.addEventListener("click", () => buyOrEquipSkin(s.id));

      skinGrid.appendChild(card);
    });
  }

  function getUpgradeCost(upg) {
    return Math.floor(upg.baseCost * Math.pow(upg.costMult, upg.level));
  }

  function renderUpgrades() {
    upgradeList.innerHTML = "";

    Object.values(upgrades).forEach(upg => {
      const card = document.createElement("div");
      card.className = "upgrade-card";

      const header = document.createElement("div");
      header.className = "upgrade-header";
      const name = document.createElement("div");
      name.textContent = upg.name;
      const lvl = document.createElement("div");
      lvl.textContent = "Lv. " + upg.level + "/" + upg.maxLevel;
      header.appendChild(name);
      header.appendChild(lvl);

      const desc = document.createElement("div");
      desc.className = "upgrade-desc";
      desc.textContent = upg.desc;

      const bottom = document.createElement("div");
      bottom.className = "upgrade-bottom";

      const levelText = document.createElement("div");
      levelText.className = "upgrade-level";
      levelText.textContent = "Bonus per level: +" + upg.perLevel.toFixed(2);

      const priceWrap = document.createElement("div");
      if (upg.level >= upg.maxLevel) {
        const max = document.createElement("div");
        max.className = "upgrade-max";
        max.textContent = "MAX";
        priceWrap.appendChild(max);
      } else {
        const price = getUpgradeCost(upg);
        const c = document.createElement("div");
        c.className = "upgrade-price";
        const coinIcon = document.createElement("div");
        coinIcon.className = "upgrade-price-coin";
        coinIcon.textContent = "C";
        const span = document.createElement("span");
        span.textContent = price;
        c.appendChild(coinIcon);
        c.appendChild(span);
        priceWrap.appendChild(c);
      }

      bottom.appendChild(levelText);
      bottom.appendChild(priceWrap);

      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(bottom);

      card.addEventListener("click", () => {
        handleUpgradePurchase(upg.id);
      });

      upgradeList.appendChild(card);
    });
  }

  function renderShop() {
    renderSkins();
    renderUpgrades();
  }

  function handleUpgradePurchase(id) {
    const upg = upgrades[id];
    if (!upg) return;
    if (upg.level >= upg.maxLevel) return;

    const cost = getUpgradeCost(upg);
    if (coins < cost) return;

    coins -= cost;
    upg.level++;
    saveCoins();
    saveUpgrades();
    updateCoinUI();
    applyBaseStats();
    renderUpgrades();
  }

  // ====== INPUT ======
  canvas.addEventListener("mousemove", (e) => {
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
  });

  shopButton.addEventListener("click", () => {
    const visible = shopPanel.classList.contains("visible");
    if (visible) shopPanel.classList.remove("visible");
    else shopPanel.classList.add("visible");
  });

  restartButton.addEventListener("click", () => {
    resetGame();
  });

  shopTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      shopTabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      const tabId = tab.dataset.tab;
      if (tabId === "skins") {
        skinGrid.style.display = "grid";
        upgradeList.style.display = "none";
      } else {
        skinGrid.style.display = "none";
        upgradeList.style.display = "flex";
      }
    });
  });

  // ====== GAME LOGIC ======
  function resetGame() {
    enemies = [];
    bullets = [];
    items = [];
    boss = null;
    inBossFight = false;
    bossIncoming = false;
    spawnCooldown = 1.6;
    spawnTimer = 0;
    wave = 1;
    enemiesThisWave = 0;
    enemiesKilledThisWave = 0;
    enemiesPerWave = 12;
    waveTransitionPause = 0;
    shootTimer = 0;
    gameOver = false;
    player.hasSecret = false;
    applyBaseStats();
    applySkinVisual();
    player.x = GAME_WIDTH / 2;
    player.y = GAME_HEIGHT / 2;
    gameOverOverlay.classList.remove("visible");
  }

  function distance(a, b) {
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function spawnEnemy() {
    if (inBossFight || bossIncoming) return;

    const size = 16 + Math.random() * 10;
    const speed = 1.0 + Math.random() * 0.8 + wave * 0.1;

    let x, y;
    const edge = Math.floor(Math.random() * 4);
    if (edge === 0) {
      x = 0 - size;
      y = Math.random() * GAME_HEIGHT;
    } else if (edge === 1) {
      x = GAME_WIDTH + size;
      y = Math.random() * GAME_HEIGHT;
    } else if (edge === 2) {
      x = Math.random() * GAME_WIDTH;
      y = 0 - size;
    } else {
      x = Math.random() * GAME_WIDTH;
      y = GAME_HEIGHT + size;
    }

    const hp = 25 + wave * 4 + Math.random() * 10;

    enemies.push({
      x,
      y,
      radius: size,
      hp,
      maxHp: hp,
      speed,
      color: "#4f46e5",
      type: "normal"
    });

    enemiesThisWave++;
  }

  function spawnBoss() {
    inBossFight = true;
    bossIncoming = true;
    bossOverlay.style.opacity = 1;

    setTimeout(() => {
      bossIncoming = false;
      bossOverlay.style.opacity = 0;
      boss = {
        x: GAME_WIDTH / 2,
        y: -80,
        targetY: 120,
        radius: 55,
        hp: 600 + wave * 120,
        maxHp: 600 + wave * 120,
        speed: 1.2,
        color: "#f97316"
      };
    }, 1500);
  }

  function spawnItem(x, y) {
    const r = Math.random();
    let type;
    if (r < 0.4) type = "heal";
    else if (r < 0.7) type = "firerate";
    else if (r < 0.9) type = "speed";
    else type = "secret";

    items.push({
      x,
      y,
      radius: 10,
      type,
      ttl: 12
    });
  }

  function spawnCoin(x, y) {
    items.push({
      x,
      y,
      radius: 8,
      type: "coin",
      ttl: 12
    });
  }

  function updatePlayer(dt) {
    const angle = Math.atan2(mouseY - player.y, mouseX - player.x);
    const speed = player.speed;

    player.x += Math.cos(angle) * speed * dt * 60 * 0.3;
    player.y += Math.sin(angle) * speed * dt * 60 * 0.3;

    player.x = Math.max(player.radius + 5, Math.min(GAME_WIDTH - player.radius - 5, player.x));
    player.y = Math.max(player.radius + 5, Math.min(GAME_HEIGHT - player.radius - 5, player.y));
  }

  function updateShooting(dt) {
    shootTimer += dt;
    const interval = 1 / player.fireRate;
    if (shootTimer >= interval) {
      shootTimer = 0;
      const angle = Math.atan2(mouseY - player.y, mouseX - player.x);
      bullets.push({
        x: player.x,
        y: player.y,
        angle,
        speed: 420,
        radius: 6,
        dmg: player.dmg
      });
    }
  }

  function updateEnemies(dt) {
    enemies.forEach(e => {
      const angle = Math.atan2(player.y - e.y, player.x - e.x);
      e.x += Math.cos(angle) * e.speed * dt * 60;
      e.y += Math.sin(angle) * e.speed * dt * 60;

      const dist = distance(player, e);
      if (dist < player.radius + e.radius) {
        const dmgTaken = 10 + Math.random() * 6;
        player.hp -= dmgTaken;
        updateHPUI();
        e.hp -= player.dmg * 0.5;

        const push = 10;
        player.x -= Math.cos(angle) * push;
        player.y -= Math.sin(angle) * push;

        if (player.hp <= 0 && !gameOver) {
          handleGameOver();
        }
      }
    });

    enemies = enemies.filter(e => e.hp > 0);

    const totalToSpawn = enemiesPerWave;
    if (!inBossFight && enemiesKilledThisWave >= totalToSpawn && enemies.length === 0 && !bossIncoming) {
      spawnBoss();
    }
  }

  function updateBoss(dt) {
    if (!boss) return;

    if (boss.y < boss.targetY) {
      boss.y += dt * 60 * 1.5;
    } else {
      boss.y += Math.sin(performance.now() / 600) * 0.3;
    }

    const dist = distance(player, boss);
    if (dist < player.radius + boss.radius - 10) {
      player.hp -= 20 * dt;
      updateHPUI();
      if (player.hp <= 0 && !gameOver) {
        handleGameOver();
      }
    }
  }

  function updateBullets(dt) {
    bullets.forEach(b => {
      b.x += Math.cos(b.angle) * b.speed * dt;
      b.y += Math.sin(b.angle) * b.speed * dt;
    });

    bullets = bullets.filter(b =>
      b.x >= -20 && b.x <= GAME_WIDTH + 20 &&
      b.y >= -20 && b.y <= GAME_HEIGHT + 20
    );

    bullets.forEach(b => {
      enemies.forEach(e => {
        const d = Math.hypot(b.x - e.x, b.y - e.y);
        if (d < b.radius + e.radius) {
          e.hp -= b.dmg;
          b.toDelete = true;

          if (e.hp <= 0) {
            enemiesKilledThisWave++;
            if (Math.random() < 0.8) spawnCoin(e.x, e.y);
            if (Math.random() < 0.3) spawnItem(e.x, e.y);
          }
        }
      });

      if (boss) {
        const d = Math.hypot(b.x - boss.x, b.y - boss.y);
        if (d < b.radius + boss.radius) {
          boss.hp -= b.dmg * 0.7;
          b.toDelete = true;
          if (boss.hp <= 0) {
            inBossFight = false;
            boss = null;
            wave++;
            enemiesPerWave += 4;
            enemiesKilledThisWave = 0;
            enemiesThisWave = 0;
            spawnCooldown = Math.max(0.8, spawnCooldown - 0.15);
            waveTransitionPause = 1.8;

            coins += 50;
            updateCoinUI();
            saveCoins();
          }
        }
      }
    });

    bullets = bullets.filter(b => !b.toDelete);
  }

  function updateItems(dt) {
    items.forEach(i => i.ttl -= dt);
    items = items.filter(i => i.ttl > 0);

    items.forEach(i => {
      const d = Math.hypot(player.x - i.x, player.y - i.y);
      if (d < player.radius + i.radius + 5) {
        if (i.type === "coin") {
          const gained = 3 + Math.floor(Math.random() * 4);
          coins += gained;
          updateCoinUI();
          saveCoins();
        } else if (i.type === "heal") {
          player.hp = Math.min(player.maxHp, player.hp + 25);
          updateHPUI();
        } else if (i.type === "firerate") {
          player.fireRate += 0.4;
        } else if (i.type === "speed") {
          player.speed += 0.4;
        } else if (i.type === "secret") {
          player.hasSecret = true;
          applyBaseStats();
          applySkinVisual();
        }
        i.ttl = -1;
      }
    });

    items = items.filter(i => i.ttl > 0);
  }

  function handleGameOver() {
    gameOver = true;
    gameOverOverlay.classList.add("visible");
    saveCoins();
  }

  function updateSpawn(dt) {
    if (inBossFight || bossIncoming) return;

    if (waveTransitionPause > 0) {
      waveTransitionPause -= dt;
      return;
    }

    spawnTimer += dt;
    if (spawnTimer >= spawnCooldown && enemiesThisWave < enemiesPerWave) {
      spawnTimer = 0;
      spawnEnemy();
    }
  }

  // ====== RENDER ======
  function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    const angle = Math.atan2(mouseY - player.y, mouseX - player.x);
    ctx.rotate(angle);

    ctx.fillStyle = player.color;
    ctx.beginPath();
    ctx.ellipse(0, 0, player.radius + 4, player.radius, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = player.outline;
    ctx.lineWidth = 4;
    ctx.stroke();

    ctx.fillStyle = "#fffaf0";
    ctx.beginPath();
    ctx.roundRect(player.radius - 4, -6, 14, 12, 6);
    ctx.fill();

    ctx.rotate(-angle);
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(-6, -4, 4, 0, Math.PI * 2);
    ctx.arc(-6, 4, 4, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#111827";
    ctx.beginPath();
    ctx.arc(-7, -4, 2, 0, Math.PI * 2);
    ctx.arc(-7, 4, 2, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
  }

  function drawEnemies() {
    enemies.forEach(e => {
      ctx.save();
      ctx.translate(e.x, e.y);
      ctx.fillStyle = e.color;
      ctx.beginPath();
      ctx.arc(0, 0, e.radius, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = "#c4b5fd";
      ctx.lineWidth = 3;
      ctx.stroke();

      const hpRatio = e.hp / e.maxHp;
      const barWidth = e.radius * 1.6;
      ctx.fillStyle = "#11182733";
      ctx.fillRect(-barWidth / 2, -e.radius - 10, barWidth, 6);
      ctx.fillStyle = hpRatio > 0.4 ? "#22c55e" : "#ef4444";
      ctx.fillRect(-barWidth / 2, -e.radius - 10, barWidth * hpRatio, 6);
      ctx.restore();
    });
  }

  function drawBoss() {
    if (!boss) return;
    ctx.save();
    ctx.translate(boss.x, boss.y);

    const t = performance.now() / 300;
    const pulse = Math.sin(t) * 4;

    const gradient = ctx.createRadialGradient(0, -10, 10, 0, 0, boss.radius + 20);
    gradient.addColorStop(0, "#fff7ed");
    gradient.addColorStop(0.4, "#fed7aa");
    gradient.addColorStop(0.8, "#ea580c");

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(0, 0, boss.radius + pulse, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "#7c2d12";
    ctx.lineWidth = 5;
    ctx.stroke();

    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(-18, -8, 8, 0, Math.PI * 2);
    ctx.arc(18, -8, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#111827";
    ctx.beginPath();
    ctx.arc(-19, -8, 4, 0, Math.PI * 2);
    ctx.arc(17, -8, 4, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "#7c2d12";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(0, 10, 18, 0.15 * Math.PI, 0.85 * Math.PI);
    ctx.stroke();

    const w = 200;
    const ratio = boss.hp / boss.maxHp;
    ctx.fillStyle = "#11182755";
    ctx.fillRect(-w / 2, boss.radius + 10, w, 10);
    ctx.fillStyle = "#f97316";
    ctx.fillRect(-w / 2, boss.radius + 10, w * ratio, 10);

    ctx.restore();
  }

  function drawBullets() {
    bullets.forEach(b => {
      ctx.save();
      ctx.translate(b.x, b.y);
      ctx.rotate(b.angle);
      ctx.fillStyle = "#f97316";
      ctx.beginPath();
      ctx.roundRect(-4, -3, 12, 6, 3);
      ctx.fill();
      ctx.restore();
    });
  }

  function drawItems() {
    items.forEach(i => {
      ctx.save();
      ctx.translate(i.x, i.y);

      if (i.type === "coin") {
        ctx.fillStyle = "#facc15";
        ctx.beginPath();
        ctx.arc(0, 0, i.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#b45309";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.fillStyle = "#b45309";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("C", 0, 1);
      } else if (i.type === "heal") {
        ctx.fillStyle = "#bbf7d0";
        ctx.beginPath();
        ctx.roundRect(-10, -10, 20, 20, 5);
        ctx.fill();
        ctx.fillStyle = "#16a34a";
        ctx.fillRect(-3, -7, 6, 14);
        ctx.fillRect(-7, -3, 14, 6);
      } else if (i.type === "firerate") {
        ctx.fillStyle = "#e0f2fe";
        ctx.beginPath();
        ctx.roundRect(-10, -10, 20, 20, 5);
        ctx.fill();
        ctx.fillStyle = "#0ea5e9";
        ctx.beginPath();
        ctx.moveTo(-5, 7);
        ctx.lineTo(5, -7);
        ctx.lineTo(0, -7);
        ctx.lineTo(0, -12);
        ctx.lineTo(-5, 2);
        ctx.lineTo(0, 2);
        ctx.closePath();
        ctx.fill();
      } else if (i.type === "speed") {
        ctx.fillStyle = "#fef3c7";
        ctx.beginPath();
        ctx.roundRect(-10, -10, 20, 20, 5);
        ctx.fill();
        ctx.fillStyle = "#fbbf24";
        ctx.beginPath();
        ctx.moveTo(-8, 4);
        ctx.lineTo(0, -6);
        ctx.lineTo(0, 0);
        ctx.lineTo(8, -10);
        ctx.lineTo(0, 10);
        ctx.closePath();
        ctx.fill();
      } else if (i.type === "secret") {
        const t = performance.now() / 400;
        const radius = 12 + Math.sin(t) * 2;
        const gradient = ctx.createRadialGradient(0, 0, 4, 0, 0, radius);
        gradient.addColorStop(0, "#fef9c3");
        gradient.addColorStop(0.5, "#a855f7");
        gradient.addColorStop(1, "#f97316");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, radius, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.restore();
    });
  }

  function drawBackgroundDecor() {
    ctx.save();
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#fee2e2";
    for (let i = 0; i < 8; i++) {
      const x = (i * 120 + (performance.now() / 20)) % (GAME_WIDTH + 200) - 100;
      const y = 70 + Math.sin((x + i * 20) / 80) * 20;
      ctx.beginPath();
      ctx.arc(x, y, 18, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawWaveInfo() {
    ctx.save();
    ctx.fillStyle = "#6b21a8";
    ctx.font = "bold 16px 'Segoe UI'";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText("Wave " + wave, 12, GAME_HEIGHT - 26);
    ctx.restore();
  }

  // ===== MAIN LOOP =====
  function gameLoop(timestamp) {
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
    drawBackgroundDecor();

    if (!gameOver) {
      updatePlayer(dt);
      updateShooting(dt);
      updateSpawn(dt);
      updateEnemies(dt);
      updateBoss(dt);
      updateBullets(dt);
      updateItems(dt);
    }

    drawItems();
    drawEnemies();
    drawBoss();
    drawBullets();
    drawPlayer();
    drawWaveInfo();

    requestAnimationFrame(gameLoop);
  }

  // ===== INIT =====
  loadPersisted();
  updateCoinUI();
  applySkinVisual();
  applyBaseStats();
  renderShop();
  requestAnimationFrame(gameLoop);
</script>
</body>
</html>
