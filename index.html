<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neon Rift — Aimed</title>
<style>
  :root {
    --bg: #0b0f14;
    --grid: rgba(0, 255, 200, 0.06);
    --hud: #c8faff;
    --hp-green: #36fba1;
    --hp-yellow: #ffd166;
    --hp-red: #ff4d6d;
    --accent: #6cf6ff;
    --boss: #ff2e88;
    --coin: #ffd54f;
  }
  html, body {
    height: 100%;
    margin: 0;
    background: radial-gradient(1200px at 50% 50%, #0d1520, var(--bg));
    font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    color: #eaf6f7;
    overflow: hidden;
  }
  #wrap {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 0;
    height: 100%;
  }
  #game {
    position: relative;
    background:
      linear-gradient(transparent 95%, var(--grid) 95%) 0 0/100% 24px,
      linear-gradient(90deg, transparent 95%, var(--grid) 95%) 0 0/24px 100%;
  }
  canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }
  #hud {
    border-left: 1px solid rgba(108, 246, 255, 0.2);
    backdrop-filter: blur(8px);
    background: linear-gradient(180deg, rgba(12,22,30,0.55), rgba(12,22,30,0.25));
    padding: 14px 16px;
  }
  .section { margin-bottom: 18px; }
  .title {
    font-weight: 600;
    letter-spacing: 0.3px;
    color: var(--accent);
    margin-bottom: 8px;
  }
  #hpBar {
    height: 16px; border-radius: 8px; background: rgba(255,255,255,0.08);
    box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
    overflow: hidden;
  }
  #hpFill {
    height: 100%; width: 100%; background: var(--hp-green);
    box-shadow: 0 0 10px rgba(54,251,161,0.5);
    transition: width 140ms ease, background 140ms ease;
  }
  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px; }
  .pill {
    padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,0.06);
    border: 1px solid rgba(108, 246, 255, 0.18); color: var(--hud); font-size: 13px;
  }
  .btn {
    appearance: none; border: 1px solid rgba(108,246,255,0.35); background: rgba(12,22,30,0.5);
    color: #eaf6f7; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 600;
    transition: transform .06s ease, background .2s, border-color .2s;
  }
  .btn:hover { transform: translateY(-1px); background: rgba(16,26,34,0.7); }
  .btn:active { transform: translateY(0); }
  .btn.small { padding: 6px 8px; font-size: 13px; }
  #shop, #skins { display: grid; gap: 8px; }
  .card {
    border: 1px solid rgba(108, 246, 255, 0.25);
    background: linear-gradient(180deg, rgba(12,22,30,0.5), rgba(12,22,30,0.25));
    border-radius: 12px; padding: 10px;
  }
  .card h4 { margin: 0 0 6px; font-size: 14px; color: #b9f7ff; }
  .card .desc { font-size: 12px; color: #a6c8cc; }
  #toast {
    position: absolute; left: 20px; bottom: 20px; padding: 10px 12px;
    border-radius: 8px; background: rgba(0,0,0,0.6); border: 1px solid rgba(108,246,255,0.25);
    font-size: 13px; pointer-events:none; opacity:0; transform: translateY(8px);
    transition: opacity .2s ease, transform .2s ease;
  }
  #toast.show { opacity:1; transform: translateY(0); }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <canvas id="c"></canvas>
    <div id="toast"></div>
  </div>
  <div id="hud">
    <div class="section">
      <div class="title">Status</div>
      <div id="hpBar"><div id="hpFill"></div></div>
      <div class="row">
        <div class="pill">Wave: <span id="wave">1</span></div>
        <div class="pill">Koin: <span id="coins">0</span></div>
        <div class="pill">Skor: <span id="score">0</span></div>
      </div>
      <div class="row">
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>

    <div class="section">
      <div class="title">Shop</div>
      <div id="shop">
        <div class="card">
          <h4>Upgrade Damage — 30 koin</h4>
          <p class="desc">Nambah output tembakan +10%.</p>
          <button class="btn small" id="upDamage">Beli</button>
        </div>
        <div class="card">
          <h4>Upgrade Rate Fire — 40 koin</h4>
          <p class="desc">Kurangi cooldown tembak 8%.</p>
          <button class="btn small" id="upRate">Beli</button>
        </div>
        <div class="card">
          <h4>Upgrade HP — 50 koin</h4>
          <p class="desc">Tambah max HP +20 dan heal +20.</p>
          <button class="btn small" id="upHP">Beli</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="title">Skin</div>
      <div id="skins">
        <div class="card">
          <h4>Default — gratis</h4>
          <p class="desc">Seimbang, peluru cyan.</p>
          <button class="btn small skinBtn" data-skin="default">Pakai</button>
        </div>
        <div class="card">
          <h4>Pulse — 60 koin</h4>
          <p class="desc">+5% move speed, peluru magenta.</p>
          <button class="btn small skinBtn" data-skin="pulse">Beli/Pakai</button>
        </div>
        <div class="card">
          <h4>Nova — 80 koin</h4>
          <p class="desc">+8% damage, peluru kuning.</p>
          <button class="btn small skinBtn" data-skin="nova">Beli/Pakai</button>
        </div>
        <div class="card">
          <h4>Aether (rahasia)</h4>
          <p class="desc">Unlock lewat secret item. +6% speed, +6% damage, aura neon.</p>
          <button class="btn small skinBtn" data-skin="aether" disabled>Aether terkunci</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const toast = document.getElementById('toast');
  const hpFill = document.getElementById('hpFill');
  const ui = {
    wave: document.getElementById('wave'),
    coins: document.getElementById('coins'),
    score: document.getElementById('score'),
    pauseBtn: document.getElementById('pauseBtn'),
    resetBtn: document.getElementById('resetBtn'),
    upDamage: document.getElementById('upDamage'),
    upRate: document.getElementById('upRate'),
    upHP: document.getElementById('upHP'),
    skinBtns: Array.from(document.querySelectorAll('.skinBtn')),
  };

  function resize() { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
  window.addEventListener('resize', resize);
  resize();

  // Input
  const keys = {};
  window.addEventListener('keydown', (e) => { keys[e.code] = true; });
  window.addEventListener('keyup',   (e) => { keys[e.code] = false; });

  // Mouse aim
  const mouse = { x: canvas.width/2, y: canvas.height/3 };
  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = (e.clientX - rect.left) * (canvas.width / rect.width);
    mouse.y = (e.clientY - rect.top)  * (canvas.height / rect.height);
  });

  // Utils
  const rand = (a=0, b=1) => a + Math.random() * (b - a);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const lerp = (a,b,t) => a + (b - a) * t;
  const dist = (ax,ay,bx,by) => Math.hypot(ax-bx, ay-by);
  const now = () => performance.now();

  // State
  const state = {
    running: true,
    score: 0,
    coins: 0,
    wave: 1,
    player: {
      x: 380, y: 300, r: 14,
      vx: 0, vy: 0,
      speed: 2.4,
      hp: 100, maxHp: 100,
      iframes: 0,
      shootCD: 0,
      shootDelay: 180,
      dashCD: 0,
      damage: 10,
      skin: 'default',
      color: '#6cf6ff',
    },
    bullets: [],
    enemies: [],
    particles: [],
    drops: [],
    boss: null,
    spawn: {
      enemyCooldown: 1200, // ms
      lastSpawn: 0,
      enemiesToSpawn: 6,
    },
    upgrades: {
      damageLvl: 0,
      rateLvl: 0,
      hpLvl: 0,
      skinsOwned: new Set(['default']),
    }
  };

  function showToast(text) {
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1200);
  }
  function hpBarUpdate() {
    const p = state.player;
    const pct = clamp(p.hp / p.maxHp, 0, 1);
    hpFill.style.width = (pct * 100).toFixed(1) + '%';
    let col = '--hp-green', glow = 'rgba(54,251,161,0.5)';
    if (pct < 0.5 && pct >= 0.25) { col = '--hp-yellow'; glow = 'rgba(255,209,102,0.5)'; }
    else if (pct < 0.25) { col = '--hp-red'; glow = 'rgba(255,77,109,0.5)'; }
    hpFill.style.background = getComputedStyle(document.documentElement).getPropertyValue(col);
    hpFill.style.boxShadow = `0 0 10px ${glow}`;
  }

  // Skins
  function applySkinAttributes() {
    const p = state.player;
    if (p.skin === 'default') {
      p.speed = 2.4; p.damage = 10; p.color = '#6cf6ff';
    } else if (p.skin === 'pulse') {
      p.speed = 2.4 * 1.05; p.damage = 10; p.color = '#ff7bd1';
    } else if (p.skin === 'nova') {
      p.speed = 2.4; p.damage = 10 * 1.08; p.color = '#ffd54f';
    } else if (p.skin === 'aether') {
      p.speed = 2.4 * 1.06; p.damage = 10 * 1.06; p.color = '#b388ff';
    }
  }

  // Particles
  function addParticle(x, y, color, life=600, size=2) {
    state.particles.push({x,y,vx:rand(-0.6,0.6),vy:rand(-0.6,0.6),color,life,size, born: now()});
  }
  function drawParticles(t) {
    for (let i = state.particles.length - 1; i >= 0; i--) {
      const p = state.particles[i];
      const age = t - p.born;
      if (age > p.life) { state.particles.splice(i,1); continue; }
      const a = 1 - age / p.life;
      p.x += p.vx; p.y += p.vy;
      ctx.fillStyle = `rgba(${hexToRGB(p.color)}, ${a})`;
      ctx.fillRect(p.x, p.y, p.size, p.size);
    }
  }
  function hexToRGB(hex) {
    const h = hex.replace('#','');
    const r = parseInt(h.substring(0,2), 16);
    const g = parseInt(h.substring(2,4), 16);
    const b = parseInt(h.substring(4,6), 16);
    return `${r}, ${g}, ${b}`;
  }

  // Waves & spawns
  function scheduleWave() {
    const s = state.spawn;
    s.enemyCooldown = Math.max(500, 1200 - (state.wave-1) * 80);
    s.enemiesToSpawn = Math.min(16, 6 + Math.floor((state.wave-1) * 1.5));
    state.boss = null;
    if (state.wave % 5 === 0) spawnBoss();
  }

  function spawnEnemy() {
    const side = Math.floor(rand(0,4));
    let x=0,y=0;
    if (side===0) { x=rand(0,canvas.width); y=-20; }
    if (side===1) { x=canvas.width+20; y=rand(0,canvas.height); }
    if (side===2) { x=rand(0,canvas.width); y=canvas.height+20; }
    if (side===3) { x=-20; y=rand(0,canvas.height); }
    const hp = 20 + state.wave*3;
    const speed = rand(0.8,1.4) + state.wave*0.02;
    state.enemies.push({
      x,y,r:12,hp,maxHp:hp,speed,
      fireCD: rand(600,1100),
      lastShot: now(),
      color: '#48ffe6',
      type: 'grunt'
    });
  }

  function spawnBoss() {
    state.boss = {
      x: canvas.width/2, y: -60, r: 26,
      hp: 600 + state.wave * 40, maxHp: 600 + state.wave * 40,
      speed: 1.2, phase: 1, color: '#ff2e88',
      volleyCD: 1400, lastVolley: now(),
      sweepCD: 2200, lastSweep: now(),
    };
    showToast('Bos muncul!');
  }

  // Drops (termasuk secret item 0.1%)
  function tryDrops(x,y) {
    if (Math.random() < 0.18) state.drops.push({x,y,type:'coin', value: 1+Math.floor(rand(0,3))});
    if (Math.random() < 0.10) state.drops.push({x,y,type:'heal', value: 12});
    if (Math.random() < 0.08) state.drops.push({x,y,type:'overcharge', value: 2500});
    if (Math.random() < 0.06) state.drops.push({x,y,type:'shield', value: 1800});
    if (Math.random() < 1.0) state.drops.push({x,y,type:'secret', value: 1});
  }

  // Player update
  function updatePlayer(dt) {
    const p = state.player;
    const sp = p.speed;
    let dx=0, dy=0;
    if (keys['KeyW'] || keys['ArrowUp']) dy -= 1;
    if (keys['KeyS'] || keys['ArrowDown']) dy += 1;
    if (keys['KeyA'] || keys['ArrowLeft']) dx -= 1;
    if (keys['KeyD'] || keys['ArrowRight']) dx += 1;
    const mag = Math.hypot(dx,dy) || 1;
    p.vx = dx/mag * sp;
    p.vy = dy/mag * sp;
    p.x = clamp(p.x + p.vx, 20, canvas.width - 20);
    p.y = clamp(p.y + p.vy, 20, canvas.height - 20);

    // Dash
    p.dashCD = Math.max(0, p.dashCD - dt);
    if ((keys['ShiftLeft'] || keys['ShiftRight']) && p.dashCD <= 0) {
      p.dashCD = 1200; p.iframes = 300;
      addParticle(p.x, p.y, '#ffffff', 400, 3);
      showToast('Dash!');
    }
    p.iframes = Math.max(0, p.iframes - dt);

    // Shooting toward cursor
    p.shootCD = Math.max(0, p.shootCD - dt);
    const rapid = rapidLeft();
    const canShoot = p.shootCD <= 0;
    if (keys['Space'] && canShoot) {
      const angle = Math.atan2(mouse.y - p.y, mouse.x - p.x);
      const spread = 0.08; // sedikit sebaran
      shootBullet(angle, 1.0);
      shootBullet(angle - spread, 0.8);
      shootBullet(angle + spread, 0.8);
      p.shootCD = Math.max(60, p.shootDelay * (rapid ? 0.35 : (1 - state.upgrades.rateLvl*0.08)));
    }
  }

  function shootBullet(angle, scale=1) {
    const p = state.player;
    const speed = 5.2;
    const vx = Math.cos(angle) * speed;
    const vy = Math.sin(angle) * speed;
    state.bullets.push({
      x: p.x, y: p.y, vx, vy,
      color: p.color, damage: currentDamage() * scale
    });
  }

  function currentDamage() {
    const p = state.player;
    let base = p.damage * (1 + state.upgrades.damageLvl * 0.10);
    if (p.skin === 'nova') base *= 1.08;
    if (p.skin === 'aether') base *= 1.06;
    return base;
  }
  function rapidLeft() {
    const d = state.drops.find(d => d.type === 'overchargeActive');
    return d ? d.value : 0;
  }

  function updateBullets(dt) {
    for (let i = state.bullets.length - 1; i >= 0; i--) {
      const b = state.bullets[i];
      b.x += b.vx; b.y += b.vy;
      if (b.y < -20 || b.y > canvas.height+20 || b.x < -20 || b.x > canvas.width+20) {
        state.bullets.splice(i,1);
      }
    }
  }

  function updateEnemies(dt, t) {
    const p = state.player;

    // Spawn cooldown
    const s = state.spawn;
    if (!state.boss) {
      if (s.enemiesToSpawn > 0 && t - s.lastSpawn > s.enemyCooldown) {
        spawnEnemy();
        s.lastSpawn = t;
        s.enemiesToSpawn--;
      }
      if (s.enemiesToSpawn <= 0 && state.enemies.length === 0) {
        state.wave++;
        ui.wave.textContent = state.wave;
        scheduleWave();
        showToast('Wave berikutnya!');
      }
    }

    // Boss logic
    if (state.boss) {
      const b = state.boss;
      b.y = lerp(b.y, canvas.height * 0.25, 0.02);
      if (b.hp < b.maxHp * 0.5 && b.phase === 1) {
        b.phase = 2; b.volleyCD *= 0.8; b.sweepCD *= 0.8;
        showToast('Bos marah!');
      }
      if (t - b.lastVolley > b.volleyCD) {
        b.lastVolley = t;
        const shots = 18 + (b.phase===2?6:0);
        for (let i=0;i<shots;i++) {
          const a = (i / shots) * Math.PI * 2;
          state.enemies.push({
            x: b.x, y: b.y, r: 6, hp: 1, maxHp: 1,
            speed: 2.2 + (b.phase===2?0.6:0),
            fireCD: 999999, lastShot: t, color: '#ff8abf', type: 'bosShot',
            vx: Math.cos(a) * 2.6, vy: Math.sin(a) * 2.6
          });
        }
      }
      if (t - b.lastSweep > b.sweepCD) {
        b.lastSweep = t;
        for (let i=0;i<6;i++) {
          state.enemies.push({
            x: rand(40, canvas.width-40), y: -10, r: 7, hp: 1, maxHp: 1,
            speed: 3.0 + (b.phase===2?0.6:0),
            fireCD: 999999, lastShot: t, color: '#ff2e88', type: 'bosSweep',
            vx: 0, vy: 3.4
          });
        }
      }
    }

    // Enemy behavior
    for (let i = state.enemies.length - 1; i >= 0; i--) {
      const e = state.enemies[i];
      if (e.type === 'grunt') {
        const angle = Math.atan2(p.y - e.y, p.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;
        if (now() - e.lastShot > e.fireCD) {
          e.lastShot = now();
          const a = Math.atan2(p.y - e.y, p.x - e.x);
          state.enemies.push({
            x: e.x, y: e.y, r: 6, hp: 1, maxHp: 1, speed: 3.0,
            fireCD: 999999, lastShot: now(), color: '#b3fff7', type: 'shot',
            vx: Math.cos(a) * 3.2, vy: Math.sin(a) * 3.2
          });
        }
      } else {
        e.x += e.vx || 0; e.y += e.vy || 0;
      }

      if ((e.type === 'shot' || e.type === 'bosShot' || e.type === 'bosSweep') &&
          (e.x < -30 || e.x > canvas.width+30 || e.y < -30 || e.y > canvas.height+30)) {
        state.enemies.splice(i,1);
        continue;
      }

      // Bullet collision
      for (let j = state.bullets.length - 1; j >= 0; j--) {
        const b = state.bullets[j];
        if (dist(e.x,e.y,b.x,b.y) < e.r + 3) {
          e.hp -= b.damage;
          addParticle(e.x, e.y, e.color, 500, 2);
          state.bullets.splice(j,1);
          if (e.hp <= 0) {
            state.score += (e.type==='grunt'?5:1);
            ui.score.textContent = state.score;
            if (e.type === 'grunt') tryDrops(e.x, e.y);
            state.enemies.splice(i,1);
            break;
          }
        }
      }

      // Player collision
      if (dist(e.x,e.y,state.player.x,state.player.y) < e.r + state.player.r) {
        if (state.player.iframes <= 0) damagePlayer(e.type === 'grunt' ? 16 : 10);
        if (e.type !== 'grunt') state.enemies.splice(i,1);
      }
    }

    // Boss bullet collision
    if (state.boss) {
      const b = state.boss;
      for (let j = state.bullets.length - 1; j >= 0; j--) {
        const bl = state.bullets[j];
        if (dist(b.x,b.y,bl.x,bl.y) < b.r + 6) {
          b.hp -= bl.damage * 0.8;
          addParticle(b.x, b.y, b.color, 600, 3);
          state.bullets.splice(j,1);
          if (b.hp <= 0) {
            state.score += 200;
            ui.score.textContent = state.score;
            for (let k=0;k<8;k++) tryDrops(b.x + rand(-10,10), b.y + rand(-10,10));
            showToast('Bos kalah!');
            state.boss = null;
          }
        }
      }
    }
  }

  function damagePlayer(dmg) {
    const p = state.player;
    p.hp = Math.max(0, p.hp - dmg);
    hpBarUpdate();
    for (let i=0;i<6;i++) addParticle(p.x, p.y, '#ffffff', 300, 2);
    if (p.hp <= 0) { state.running = false; showToast('Game Over'); }
  }

  // Drops update
  function updateDrops(dt) {
    for (let i = state.drops.length - 1; i >= 0; i--) {
      const d = state.drops[i];
      if (d.type !== 'overchargeActive') {
        d.y += 0.6;
        d.x += Math.sin(d.y * 0.02) * 0.2;
      }
      if (dist(d.x,d.y,state.player.x,state.player.y) < state.player.r + 10) {
        if (d.type === 'coin') {
          state.coins += d.value; ui.coins.textContent = state.coins; showToast(`+${d.value} koin`);
        } else if (d.type === 'heal') {
          state.player.hp = clamp(state.player.hp + d.value, 0, state.player.maxHp); hpBarUpdate(); showToast(`+${d.value} HP`);
        } else if (d.type === 'overcharge') {
          state.drops.push({type:'overchargeActive', value: 2500, x:0, y:0}); showToast('Overcharge!');
        } else if (d.type === 'shield') {
          state.player.iframes = Math.max(state.player.iframes, 1200); showToast('Shield!');
        } else if (d.type === 'secret') {
          unlockAether();
          showToast('Secret Core ditemukan! Skin Aether terbuka');
        }
        state.drops.splice(i,1);
      }
    }
    const oc = state.drops.find(d => d.type === 'overchargeActive');
    if (oc) {
      oc.value = Math.max(0, oc.value - dt);
      if (oc.value <= 0) {
        const idx = state.drops.indexOf(oc);
        if (idx >= 0) state.drops.splice(idx,1);
        showToast('Overcharge habis');
      }
    }
  }

  function unlockAether() {
    state.upgrades.skinsOwned.add('aether');
    const btn = document.querySelector('.skinBtn[data-skin="aether"]');
    if (btn) { btn.disabled = false; btn.textContent = 'Pakai'; }
  }

  // Rendering
  function drawPlayer(t) {
    const p = state.player;
    ctx.save();
    ctx.shadowColor = p.color; ctx.shadowBlur = 12;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fillStyle = p.color; ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.fillRect(p.x-2, p.y-18, 4, 8);
    ctx.restore();

    // Aether aura
    if (p.skin === 'aether') {
      const pulse = 4 + Math.sin(t * 0.006) * 2;
      ctx.strokeStyle = 'rgba(179,136,255,0.7)';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r + pulse, 0, Math.PI*2); ctx.stroke();
    }

    // iframes ring
    if (p.iframes > 0) {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r+4, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(255,255,255,0.7)';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // Aim reticle ke kursor
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    ctx.moveTo(mouse.x-8, mouse.y); ctx.lineTo(mouse.x+8, mouse.y);
    ctx.moveTo(mouse.x, mouse.y-8); ctx.lineTo(mouse.x, mouse.y+8);
    ctx.stroke();
  }

  function drawEnemies() {
    for (const e of state.enemies) {
      ctx.save();
      ctx.shadowColor = e.color; ctx.shadowBlur = 8;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
      ctx.fillStyle = e.color; ctx.fill();
      ctx.restore();
    }
    if (state.boss) {
      const b = state.boss;
      ctx.save();
      ctx.shadowColor = b.color; ctx.shadowBlur = 18;
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fillStyle = b.color; ctx.fill();
      ctx.restore();
      const w = canvas.width * 0.5, h = 8, x = canvas.width * 0.25, y = 18;
      const pct = clamp(b.hp/b.maxHp, 0, 1);
      ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.strokeRect(x, y, w, h);
      ctx.fillStyle = '#ff2e88'; ctx.fillRect(x, y, w * pct, h);
    }
  }

  function drawBullets() {
    for (const b of state.bullets) {
      ctx.save();
      ctx.shadowColor = b.color; ctx.shadowBlur = 10;
      ctx.fillStyle = b.color;
      ctx.fillRect(b.x-2, b.y-2, 6, 6); // bullet kecil, arah bebas
      ctx.restore();
    }
  }

  function drawDrops() {
    for (const d of state.drops) {
      if (d.type === 'coin') {
        ctx.save(); ctx.shadowColor = '#ffd54f'; ctx.shadowBlur = 8;
        ctx.fillStyle = '#ffd54f'; ctx.beginPath(); ctx.arc(d.x,d.y,6,0,Math.PI*2); ctx.fill(); ctx.restore();
      } else if (d.type === 'heal') {
        ctx.fillStyle = '#36fba1'; ctx.fillRect(d.x-5,d.y-5,10,10);
      } else if (d.type === 'overcharge') {
        ctx.fillStyle = '#ff7bd1'; ctx.beginPath(); ctx.moveTo(d.x, d.y-6); ctx.lineTo(d.x+6,d.y+6); ctx.lineTo(d.x-6,d.y+6); ctx.closePath(); ctx.fill();
      } else if (d.type === 'shield') {
        ctx.strokeStyle = '#6cf6ff'; ctx.beginPath(); ctx.arc(d.x,d.y,7,0,Math.PI*2); ctx.stroke();
      } else if (d.type === 'secret') {
        ctx.save();
        ctx.shadowColor = '#b388ff'; ctx.shadowBlur = 14;
        ctx.strokeStyle = '#b388ff'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(d.x,d.y,10,0,Math.PI*2); ctx.stroke();
        ctx.fillStyle = 'rgba(179,136,255,0.25)';
        ctx.beginPath(); ctx.arc(d.x,d.y,6,0,Math.PI*2); ctx.fill();
        ctx.restore();
      }
    }
    const oc = state.drops.find(d => d.type === 'overchargeActive');
    if (oc) {
      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      ctx.font = '12px Segoe UI';
      ctx.fillText('Overcharge', 12, 36);
    }
  }

  // UI
  ui.pauseBtn.addEventListener('click', () => {
    state.running = !state.running;
    ui.pauseBtn.textContent = state.running ? 'Pause' : 'Resume';
  });
  ui.resetBtn.addEventListener('click', resetGame);

  ui.upDamage.addEventListener('click', () => {
    if (state.coins >= 30) { state.coins -= 30; ui.coins.textContent = state.coins; state.upgrades.damageLvl++; showToast('Damage naik'); }
    else showToast('Koin kurang');
  });
  ui.upRate.addEventListener('click', () => {
    if (state.coins >= 40) { state.coins -= 40; ui.coins.textContent = state.coins; state.upgrades.rateLvl++; showToast('Rate fire naik'); }
    else showToast('Koin kurang');
  });
  ui.upHP.addEventListener('click', () => {
    if (state.coins >= 50) { state.coins -= 50; ui.coins.textContent = state.coins; state.upgrades.hpLvl++; state.player.maxHp += 20; state.player.hp = Math.min(state.player.hp + 20, state.player.maxHp); hpBarUpdate(); showToast('HP naik'); }
    else showToast('Koin kurang');
  });

  ui.skinBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const skin = btn.dataset.skin;
      const price = skin === 'pulse' ? 60 : (skin === 'nova' ? 80 : 0);
      if (skin === 'aether' && !state.upgrades.skinsOwned.has('aether')) {
        showToast('Belum terbuka'); return;
      }
      if (!state.upgrades.skinsOwned.has(skin)) {
        if (state.coins >= price) {
          state.coins -= price; ui.coins.textContent = state.coins;
          state.upgrades.skinsOwned.add(skin);
          showToast(`Skin ${skin} dibeli`);
        } else { showToast('Koin kurang'); return; }
      }
      state.player.skin = skin;
      applySkinAttributes();
      showToast(`Skin ${skin} dipakai`);
    });
  });

  function resetGame() {
    state.score = 0; state.coins = 0; state.wave = 1;
    state.player.x = canvas.width/2; state.player.y = canvas.height*0.6;
    state.player.hp = 100; state.player.maxHp = 100; state.player.iframes = 0;
    state.player.shootDelay = 180; state.player.damage = 10; state.player.speed = 2.4; state.player.skin = 'default';
    state.upgrades.damageLvl = 0; state.upgrades.rateLvl = 0; state.upgrades.hpLvl = 0;
    state.upgrades.skinsOwned = new Set(['default']);
    const aetherBtn = document.querySelector('.skinBtn[data-skin="aether"]');
    if (aetherBtn) { aetherBtn.disabled = true; aetherBtn.textContent = 'Aether terkunci'; }
    state.bullets.length = 0; state.enemies.length = 0; state.particles.length = 0; state.drops.length = 0; state.boss = null;
    scheduleWave(); hpBarUpdate();
    ui.wave.textContent = state.wave; ui.coins.textContent = state.coins; ui.score.textContent = state.score;
    state.running = true; ui.pauseBtn.textContent = 'Pause';
  }

  // Game loop
  let last = now();
  scheduleWave(); hpBarUpdate();

  function step() {
    const t = now();
    const dt = t - last; last = t;
    if (state.running) {
      updatePlayer(dt);
      updateBullets(dt);
      updateEnemies(dt, t);
      updateDrops(dt);
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawDrops();
    drawBullets();
    drawEnemies();
    drawPlayer(t);
    drawParticles(t);
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();
</script>
</body>
</html>
